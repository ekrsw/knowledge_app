# タスクリスト - APIエンドポイントテスト包括的実装

## 概要

- **総タスク数**: 25タスク
- **推定作業時間**: 3-4週間（120-160時間）
- **優先度**: 高
- **目的**: ナレッジ修正案承認システムの全APIエンドポイントに対する包括的テストカバレッジの実現

## タスク一覧

### Phase 1: テスト環境・データファクトリー（完了済み）

#### ✅ Task 1.1: テスト環境セットアップ

- ✅ pytest-asyncio設定とconftest.py整備
- ✅ SQLite in-memoryテストDB設定
- ✅ FakeRedis統合設定
- ✅ JWT認証テストヘルパー作成
- ✅ テスト用フィクスチャ作成
- **完了条件**: 全フィクスチャが動作し、認証テストが可能
- **依存**: なし
- **推定時間**: 4時間 ✅完了

#### ✅ Task 1.2: テストデータファクトリー作成

- ✅ UserFactory, ApprovalGroupFactory作成
- ✅ InfoCategoryFactory, ArticleFactory作成
- ✅ RevisionFactory, NotificationFactory作成
- ✅ 全ファクトリーの動作検証とエラー修正
- **完了条件**: 全6エンティティのファクトリーが完璧に動作
- **依存**: Task 1.1
- **推定時間**: 6時間 ✅完了

### Phase 2: 認証・基盤APIテスト

#### Task 2.1: 認証API（/auth）テスト

- [ ] POST /auth/login - OAuth2フォーム認証テスト
- [ ] POST /auth/login - JSON認証テスト  
- [ ] POST /auth/register - ユーザー登録テスト
- [ ] GET /auth/me - 現在ユーザー情報取得テスト
- [ ] POST /auth/test-token - トークン検証テスト
- [ ] エラーハンドリング（無効認証情報、期限切れトークン）テスト
- [ ] 統合認証フローテスト
- **完了条件**: 全認証エンドポイントのテストがパス、カバレッジ95%以上
- **依存**: Task 1.2
- **推定時間**: 8時間

#### Task 2.2: ユーザー管理API（/users）テスト

- [ ] GET /users/ - ユーザー一覧テスト（管理者権限）
- [ ] GET /users/me - 現在ユーザー情報テスト
- [ ] GET /users/{id} - 特定ユーザー取得テスト
- [ ] PUT /users/{id} - ユーザー更新テスト
- [ ] 権限チェックテスト（role-based access control）
- [ ] ページネーション・フィルタリングテスト
- **完了条件**: 全ユーザーAPIのテストがパス、権限制御正常動作
- **依存**: Task 2.1
- **推定時間**: 6時間

#### Task 2.3: マスタデータAPIテスト

- [ ] GET /approval-groups/ - 承認グループ一覧テスト
- [ ] GET /approval-groups/{id} - 承認グループ詳細テスト
- [ ] POST /approval-groups/ - 承認グループ作成テスト（管理者）
- [ ] PUT /approval-groups/{id} - 承認グループ更新テスト
- [ ] GET /info-categories/ - 情報カテゴリ一覧テスト
- [ ] GET /info-categories/{id} - 情報カテゴリ詳細テスト
- [ ] **スキップテスト修正**: `@pytest.mark.asyncio`デコレータ追加（ApprovalGroup API統合テスト10個）
- **完了条件**: 全マスタデータAPIテストがパス、スキップテスト解消
- **依存**: Task 2.2
- **推定時間**: 8時間

### Phase 3: コア業務APIテスト

#### Task 3.1: 記事管理API（/articles）テスト

- [ ] GET /articles/ - 記事一覧テスト（権限ベースフィルタリング）
- [ ] GET /articles/{id} - 記事詳細テスト
- [ ] POST /articles/ - 記事作成テスト（管理者）
- [ ] PUT /articles/{id} - 記事更新テスト
- [ ] DELETE /articles/{id} - 記事削除テスト
- [ ] 記事-承認グループ関係性テスト
- [ ] 記事検索・フィルタリング機能テスト
- **完了条件**: 全記事APIテストがパス、複雑な検索条件対応
- **依存**: Task 2.3
- **推定時間**: 8時間

#### Task 3.2: 修正案管理API（/revisions）テスト

- [ ] GET /revisions/ - 修正案一覧テスト（権限ベース）
- [ ] GET /revisions/{id} - 修正案詳細テスト
- [ ] POST /revisions/ - 修正案作成テスト（approver_id必須検証）
- [ ] PUT /revisions/{id} - 修正案更新テスト（draft状態のみ）
- [ ] DELETE /revisions/{id} - 修正案削除テスト
- [ ] ステータス遷移制御テスト
- [ ] After-onlyフィールドバリデーションテスト
- **完了条件**: 全修正案APIテストがパス、ビジネスルール厳格チェック
- **依存**: Task 3.1
- **推定時間**: 10時間

#### Task 3.3: 修正案提案API（/proposals）テスト

- [ ] POST /proposals/ - 修正案作成（ビジネスロジック層）テスト
- [ ] POST /proposals/{id}/submit - 修正案提出テスト
- [ ] POST /proposals/{id}/withdraw - 修正案撤回テスト
- [ ] PUT /proposals/{id} - 修正案更新（バリデーション強化）テスト
- [ ] 変更検証ロジックテスト（最低1つの変更必須）
- [ ] 承認者権限チェックテスト
- [ ] 複雑なビジネスルール検証テスト
- **完了条件**: ビジネスロジック層の全テストがパス、エラーケース網羅
- **依存**: Task 3.2
- **推定時間**: 10時間

### Phase 4: ワークフロー・高度機能テスト

#### Task 4.1: 承認管理API（/approvals）テスト

- [ ] POST /approvals/{id}/decide - 承認・却下処理テスト
- [ ] GET /approvals/{id}/status - 承認状況取得テスト
- [ ] GET /approvals/queue - 承認待ち一覧テスト
- [ ] GET /approvals/metrics - 承認統計テスト
- [ ] POST /approvals/bulk - 一括承認処理テスト
- [ ] 承認権限チェック（承認グループベース）テスト
- [ ] ステータス遷移ワークフローテスト
- **完了条件**: 承認ワークフロー全体の動作確認、権限制御完璧
- **依存**: Task 3.3
- **推定時間**: 12時間

#### Task 4.2: 差分表示API（/diffs）テスト

- [ ] GET /diffs/{id} - フィールドレベル差分取得テスト
- [ ] GET /diffs/{id}/preview - プレビュー表示テスト
- [ ] GET /diffs/{id}/compare - 修正案間比較テスト
- [ ] GET /diffs/{id}/history - 記事変更履歴テスト
- [ ] 複雑な差分パターンテスト（テキスト、日付、boolean等）
- [ ] After-only設計に基づく差分生成アルゴリズムテスト
- [ ] パフォーマンステスト（大容量コンテンツ）
- **完了条件**: 差分表示機能の全パターンテスト、パフォーマンス基準達成
- **依存**: Task 4.1
- **推定時間**: 10時間

#### Task 4.3: 通知管理API（/notifications）テスト

- [ ] GET /notifications/ - 通知一覧取得テスト
- [ ] GET /notifications/unread - 未読通知取得テスト
- [ ] PUT /notifications/{id}/read - 通知既読化テスト
- [ ] PUT /notifications/batch/read - 一括既読化テスト
- [ ] GET /notifications/count - 通知カウントテスト
- [ ] 通知自動生成テスト（修正案提出時、承認時等）
- [ ] 通知配信ロジックテスト
- **完了条件**: 通知システム全機能テスト、自動通知正常動作
- **依存**: Task 4.2
- **推定時間**: 8時間

#### Task 4.4: 分析・統計API（/analytics）テスト

- [ ] GET /analytics/revisions/stats - 修正案統計テスト
- [ ] GET /analytics/approvals/metrics - 承認メトリクステスト
- [ ] GET /analytics/users/activity - ユーザー活動分析テスト
- [ ] GET /analytics/trends - トレンド分析テスト
- [ ] 複雑な集計クエリテスト
- [ ] パフォーマンステスト（大量データ処理）
- [ ] 期間指定・グループ別集計テスト
- **完了条件**: 分析機能全体テスト、パフォーマンス要件達成
- **依存**: Task 4.3
- **推定時間**: 10時間

### Phase 5: シナリオテスト・統合テスト

#### Task 5.1: E2Eシナリオテスト

- [ ] 修正案作成→提出→承認フロー完全テスト
- [ ] 修正案作成→提出→却下→再編集→再承認フローテスト
- [ ] 修正案撤回フローテスト
- [ ] 複数ユーザーでの同時アクセステスト
- [ ] 異常系フロー（ネットワークエラー、DB障害等）テスト
- [ ] ブラウザ互換性テスト
- **完了条件**: 主要ビジネスフロー全体の動作確認
- **依存**: Task 4.4
- **推定時間**: 12時間

#### Task 5.2: 権限・セキュリティテスト

- [ ] 役割ベースアクセス制御（RBAC）全パターンテスト
- [ ] JWT トークン検証・期限切れテスト
- [ ] 不正アクセス試行テスト
- [ ] 入力値サニタイゼーションテスト
- [ ] SQL インジェクション対策テスト
- [ ] XSS対策テスト
- [ ] CSRF対策テスト
- **完了条件**: セキュリティ要件100%達成、脆弱性なし
- **依存**: Task 5.1
- **推定時間**: 10時間

#### Task 5.3: パフォーマンス・負荷テスト

- [ ] 同時アクセス100ユーザーテスト
- [ ] レスポンス時間テスト（3秒以内）
- [ ] 大容量コンテンツ処理テスト（10MB以上）
- [ ] データベースクエリ最適化テスト
- [ ] メモリリーク検出テスト
- [ ] Redis キャッシュ効果測定テスト
- **完了条件**: 非機能要件全て達成、パフォーマンス基準クリア
- **依存**: Task 5.2
- **推定時間**: 8時間

#### Task 5.4: エラーハンドリング・復旧テスト

- [ ] カスタム例外処理テスト
- [ ] エラーレスポンス標準化テスト
- [ ] データベース接続エラー処理テスト
- [ ] Redis接続エラー処理テスト
- [ ] 外部依存障害時の処理テスト
- [ ] ロールバック・リカバリ機能テスト
- **完了条件**: 異常系処理の網羅的テスト、サービス継続性確保
- **依存**: Task 5.3
- **推定時間**: 8時間

### Phase 6: 検証・仕上げ

#### Task 6.1: テストカバレッジ検証

- [ ] ユニットテストカバレッジ95%以上達成
- [ ] 統合テストカバレッジ90%以上達成
- [ ] **スキップテスト完全解消**: Repository単体テスト（8個）とDB接続テスト（2個）の`@pytest.mark.asyncio`デコレータ追加
- [ ] コードカバレッジレポート生成
- [ ] カバレッジ不足箇所の特定・補完
- [ ] テスト品質メトリクス測定
- **完了条件**: 全テストカテゴリで目標カバレッジ達成、スキップテスト0個
- **依存**: Task 5.4
- **推定時間**: 6時間

#### Task 6.2: システムAPI（/system）テスト

- [ ] GET /system/health - ヘルスチェックテスト
- [ ] GET /system/version - バージョン情報テスト
- [ ] GET /system/metrics - システムメトリクステスト
- [ ] POST /system/maintenance - メンテナンスモードテスト
- [ ] GET /system/database/status - DB接続状況テスト
- [ ] GET /system/redis/status - Redis接続状況テスト
- **完了条件**: システム監視・運用機能の完全テスト
- **依存**: Task 6.1
- **推定時間**: 4時間

#### Task 6.3: テストレポート・ドキュメント作成

- [ ] テスト実行結果サマリー作成
- [ ] カバレッジレポート整理
- [ ] パフォーマンステスト結果レポート
- [ ] セキュリティテスト結果レポート
- [ ] テスト仕様書更新
- [ ] CI/CD設定（GitHub Actions等）
- [ ] テスト自動化設定完了
- **完了条件**: 包括的テストドキュメント完成、自動化実現
- **依存**: Task 6.2
- **推定時間**: 6時間

## 実装順序

1. **Phase 2→3→4**: 基盤→コア→高度機能の順で確実に積み上げ
2. **並行実行可能**: Task 2.2とTask 2.3、Task 4.2とTask 4.3
3. **重要マイルストーン**: Task 3.3完了でコア機能テスト完了、Task 5.1完了でE2E確認完了

## スキップテスト解消計画

### 現在のスキップ状況（20個）
- **ApprovalGroup API統合テスト**: 10個 → Task 2.3で解消
- **ApprovalGroup Repository単体テスト**: 8個 → Task 6.1で解消  
- **データベース接続テスト**: 2個 → Task 6.1で解消

### 解消方法
```python
# 各テストファイルに以下を追加:
import pytest

@pytest.mark.asyncio  # このデコレータを全async def test_*関数に追加
async def test_example():
    pass
```

## リスクと対策

- **大量テスト実行時間**: 並列実行・テストカテゴリ分割で短縮
- **flaky テスト**: 非同期処理の待機時間調整、DB状態初期化徹底
- **Windows環境特有問題**: 文字エンコーディング統一、パス区切り文字対応
- **Redis 3.0.504制約**: 基本機能のみ使用、代替実装準備

## 注意事項

- 各タスクはコミット単位で完結させる
- タスク完了時は必ず`uv run pytest --cov=app`でカバレッジ確認
- **スキップテスト解消**: 各Phaseで該当するスキップテストを確実に修正
- 不明点は実装前に設計ドキュメント参照・確認
- Windows特有のエラー（UnicodeEncodeError等）には特に注意

## 成功基準

- ✅ 全APIエンドポイントの包括的テストカバレッジ
- ✅ スキップテスト完全解消（0個）
- ✅ ユニットテスト95%、統合テスト90%カバレッジ達成
- ✅ パフォーマンス要件（同時100ユーザー、3秒以内応答）達成
- ✅ セキュリティテスト100%パス
- ✅ CI/CDパイプライン自動化完成

## 実装開始ガイド

1. このタスクリストに従って順次実装を進めてください
2. 各タスクの開始時にTodoWriteでin_progressに更新  
3. 完了時はcompletedに更新
4. **特に重要**: スキップテストが発見されたら即座に`@pytest.mark.asyncio`デコレータを追加
5. 問題発生時は速やかに報告してください