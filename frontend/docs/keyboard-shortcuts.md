# KSAP ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆä»•æ§˜

## âŒ¨ï¸ æ‰¿èªä½œæ¥­åŠ¹ç‡åŒ–ã®ãŸã‚ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆè¨­è¨ˆ

### è¨­è¨ˆæ€æƒ³
- **å·¦æ‰‹æ“ä½œä¸­å¿ƒ**: å³æ‰‹ã¯ãƒã‚¦ã‚¹ã€å·¦æ‰‹ã¯ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®è‡ªç„¶ãªæ“ä½œ
- **è¦šãˆã‚„ã™ã„é…åˆ—**: A=Approve, R=Reject ãªã©ç›´æ„Ÿçš„ãªã‚­ãƒ¼é…ç½®
- **è¡çªå›é¿**: ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ãƒ»OSæ¨™æº–ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã¨ã®é‡è¤‡å›é¿
- **æ–‡è„ˆè€ƒæ…®**: å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã¯ç„¡åŠ¹åŒ–

## ğŸ¯ æ‰¿èªãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒšãƒ¼ã‚¸ ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆä¸€è¦§

### ä¸»è¦åˆ¤å®šã‚¢ã‚¯ã‚·ãƒ§ãƒ³
| ã‚­ãƒ¼ | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | èª¬æ˜ |
|------|-----------|------|
| `A` | **Approve** | ææ¡ˆã‚’æ‰¿èªã™ã‚‹ |
| `R` | **Reject** | ææ¡ˆã‚’å´ä¸‹ã™ã‚‹ |
| `C` | **Request Changes** | å¤‰æ›´è¦æ±‚ã‚’é€ä¿¡ã™ã‚‹ |
| `D` | **Defer** | åˆ¤å®šã‚’ä¿ç•™ã™ã‚‹ |

### ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
| ã‚­ãƒ¼ | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | èª¬æ˜ |
|------|-----------|------|
| `â†’` | **Next** | æ¬¡ã®æ‰¿èªæ¡ˆä»¶ã¸ç§»å‹• |
| `â†` | **Previous** | å‰ã®æ‰¿èªæ¡ˆä»¶ã¸ç§»å‹• |
| `Shift + â†’` | **Skip & Next** | ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ¬¡ã¸ |

### å…¥åŠ›ãƒ»æ“ä½œ
| ã‚­ãƒ¼ | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | èª¬æ˜ |
|------|-----------|------|
| `T` | **Focus Comment** | ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ |
| `Ctrl/Cmd + Enter` | **Submit Decision** | ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ä¸­ã«åˆ¤å®šé€ä¿¡ |
| `Escape` | **Cancel/Clear Focus** | ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è§£é™¤ãƒ»å…¥åŠ›ã‚¯ãƒªã‚¢ |
| `?` | **Show Help** | ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒ˜ãƒ«ãƒ—è¡¨ç¤º |

### è¡¨ç¤ºãƒ»UIåˆ¶å¾¡
| ã‚­ãƒ¼ | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | èª¬æ˜ |
|------|-----------|------|
| `Space` | **Toggle Diff Expand** | å·®åˆ†è¡¨ç¤ºã®å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿ |
| `F` | **Toggle Full Screen** | å·®åˆ†ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼å…¨ç”»é¢è¡¨ç¤º |
| `Ctrl/Cmd + +` | **Zoom In** | å·®åˆ†è¡¨ç¤ºæ‹¡å¤§ |
| `Ctrl/Cmd + -` | **Zoom Out** | å·®åˆ†è¡¨ç¤ºç¸®å° |

## ğŸ’» å®Ÿè£…ä»•æ§˜

### ã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
```typescript
// hooks/useKeyboardShortcuts.ts
interface KeyboardShortcutsConfig {
  onApprove: () => void;
  onReject: () => void;
  onRequestChanges: () => void;
  onDefer: () => void;
  onNext: () => void;
  onPrevious: () => void;
  onFocusComment: () => void;
  onToggleHelp: () => void;
}

export function useKeyboardShortcuts(config: KeyboardShortcutsConfig) {
  const [helpVisible, setHelpVisible] = useState(false);

  useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—
      if (isInputFocused(event.target)) {
        handleInputModeShortcuts(event, config);
        return;
      }

      // ãƒ¢ãƒ‡ã‚£ãƒ•ã‚¡ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ¼ã®çµ„ã¿åˆã‚ã›
      if (event.ctrlKey || event.metaKey) {
        handleModifierShortcuts(event, config);
        return;
      }

      // åŸºæœ¬ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
      switch (event.key.toLowerCase()) {
        case 'a':
          event.preventDefault();
          config.onApprove();
          break;
        case 'r':
          event.preventDefault();
          config.onReject();
          break;
        case 'c':
          event.preventDefault();
          config.onRequestChanges();
          break;
        case 'd':
          event.preventDefault();
          config.onDefer();
          break;
        case 'arrowright':
          event.preventDefault();
          config.onNext();
          break;
        case 'arrowleft':
          event.preventDefault();
          config.onPrevious();
          break;
        case 't':
          event.preventDefault();
          config.onFocusComment();
          break;
        case '?':
          event.preventDefault();
          setHelpVisible(!helpVisible);
          config.onToggleHelp();
          break;
        default:
          break;
      }
    };

    document.addEventListener('keydown', handleKeyDown);
    return () => document.removeEventListener('keydown', handleKeyDown);
  }, [config, helpVisible]);

  return { helpVisible, setHelpVisible };
}

// å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åˆ¤å®š
function isInputFocused(target: EventTarget | null): boolean {
  if (!target || !(target instanceof Element)) return false;

  const tagName = target.tagName.toLowerCase();
  const inputTypes = ['input', 'textarea', 'select'];

  return (
    inputTypes.includes(tagName) ||
    target.hasAttribute('contenteditable') ||
    target.closest('[role="textbox"]') !== null
  );
}

// å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
function handleInputModeShortcuts(
  event: KeyboardEvent,
  config: KeyboardShortcutsConfig
) {
  // Ctrl/Cmd + Enter ã§åˆ¤å®šé€ä¿¡
  if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
    event.preventDefault();
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã®åˆ¤å®šãƒœã‚¿ãƒ³ã«å¿œã˜ã¦é©åˆ‡ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
    const lastAction = getLastFocusedAction();
    switch (lastAction) {
      case 'approve':
        config.onApprove();
        break;
      case 'reject':
        config.onReject();
        break;
      case 'request_changes':
        config.onRequestChanges();
        break;
      case 'defer':
        config.onDefer();
        break;
    }
  }

  // Escape ã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è§£é™¤
  if (event.key === 'Escape') {
    (event.target as HTMLElement).blur();
  }
}

// ãƒ¢ãƒ‡ã‚£ãƒ•ã‚¡ã‚¤ãƒ¤ãƒ¼ä»˜ãã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
function handleModifierShortcuts(
  event: KeyboardEvent,
  config: KeyboardShortcutsConfig
) {
  if (event.key === 'Enter') {
    // Ctrl/Cmd + Enter ã§åˆ¤å®šé€ä¿¡
    event.preventDefault();
    // å®Ÿè£…ã¯ä¸Šè¨˜ã¨åŒæ§˜
  }
}
```

### ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
```typescript
// components/approvals/KeyboardShortcutIndicator.tsx
export function KeyboardShortcutIndicator({
  shortcut,
  description,
  active = false
}: {
  shortcut: string;
  description: string;
  active?: boolean;
}) {
  return (
    <div className={clsx(
      'flex items-center justify-between p-2 rounded',
      active && 'bg-blue-100 ring-2 ring-blue-500'
    )}>
      <span className="text-sm text-gray-700">{description}</span>
      <kbd className={clsx(
        'px-2 py-1 text-xs font-mono rounded border',
        active
          ? 'bg-blue-200 border-blue-400 text-blue-900'
          : 'bg-gray-100 border-gray-300 text-gray-700'
      )}>
        {shortcut}
      </kbd>
    </div>
  );
}

// ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆæ¡ˆå†…ãƒ‘ãƒãƒ«
export function ShortcutHelpPanel({ visible, onClose }: {
  visible: boolean;
  onClose: () => void;
}) {
  if (!visible) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-semibold">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</h3>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600"
          >
            <XMarkIcon className="w-6 h-6" />
          </button>
        </div>

        <div className="space-y-1">
          <div className="font-medium text-sm text-gray-900 mb-2">åˆ¤å®šã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
          <KeyboardShortcutIndicator shortcut="A" description="æ‰¿èªã™ã‚‹" />
          <KeyboardShortcutIndicator shortcut="R" description="å´ä¸‹ã™ã‚‹" />
          <KeyboardShortcutIndicator shortcut="C" description="å¤‰æ›´è¦æ±‚" />
          <KeyboardShortcutIndicator shortcut="D" description="ä¿ç•™ã™ã‚‹" />

          <div className="font-medium text-sm text-gray-900 mb-2 mt-4">ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³</div>
          <KeyboardShortcutIndicator shortcut="â†’" description="æ¬¡ã®æ¡ˆä»¶" />
          <KeyboardShortcutIndicator shortcut="â†" description="å‰ã®æ¡ˆä»¶" />

          <div className="font-medium text-sm text-gray-900 mb-2 mt-4">ãã®ä»–</div>
          <KeyboardShortcutIndicator shortcut="T" description="ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›" />
          <KeyboardShortcutIndicator shortcut="Ctrl+Enter" description="åˆ¤å®šé€ä¿¡" />
          <KeyboardShortcutIndicator shortcut="?" description="ã“ã®ãƒ˜ãƒ«ãƒ—" />
        </div>

        <div className="mt-6 text-xs text-gray-500">
          å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã¯ä¸€éƒ¨ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãŒç„¡åŠ¹ã«ãªã‚Šã¾ã™
        </div>
      </div>
    </div>
  );
}
```

## ğŸ¨ UIçµ±åˆ

### ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã§ã®è¡¨ç¤º
```typescript
// components/approvals/ApprovalActionButton.tsx
export function ApprovalActionButton({
  action,
  label,
  shortcut,
  variant,
  onClick,
  disabled
}: ApprovalActionButtonProps) {
  return (
    <button
      onClick={onClick}
      disabled={disabled}
      className={clsx(
        'w-full py-3 px-4 rounded-lg font-medium transition-all duration-200',
        'focus:ring-4 focus:ring-offset-2 focus:outline-none',
        'relative group',
        getVariantStyles(variant),
        disabled && 'opacity-50 cursor-not-allowed'
      )}
      aria-label={`${label}ã™ã‚‹ (ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: ${shortcut})`}
    >
      <div className="flex items-center justify-between">
        <span>{label}</span>
        <div className="flex items-center gap-2">
          {/* ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒãƒƒã‚¸ */}
          <kbd className="px-2 py-1 text-xs font-mono bg-white bg-opacity-20 rounded border border-white border-opacity-30">
            {shortcut}
          </kbd>
          {/* ã‚¢ã‚¤ã‚³ãƒ³ */}
          {getActionIcon(action)}
        </div>
      </div>

      {/* ãƒ›ãƒãƒ¼æ™‚ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */}
      <div className="absolute -top-2 left-1/2 transform -translate-x-1/2 -translate-y-full opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none">
        <div className="bg-gray-900 text-white text-xs py-1 px-2 rounded whitespace-nowrap">
          {shortcut} ã‚­ãƒ¼ã§ã‚‚å®Ÿè¡Œå¯èƒ½
        </div>
      </div>
    </button>
  );
}

function getActionIcon(action: string) {
  switch (action) {
    case 'approve':
      return <CheckIcon className="w-5 h-5" />;
    case 'reject':
      return <XMarkIcon className="w-5 h-5" />;
    case 'request_changes':
      return <ExclamationTriangleIcon className="w-5 h-5" />;
    case 'defer':
      return <ClockIcon className="w-5 h-5" />;
    default:
      return null;
  }
}
```

## ğŸš¨ æ³¨æ„äº‹é …ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ
```typescript
// WAI-ARIAå±æ€§ã®é©åˆ‡ãªè¨­å®š
<div
  role="application"
  aria-label="æ‰¿èªãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³"
  aria-describedby="shortcuts-help"
>
  <div id="shortcuts-help" className="sr-only">
    A ã‚­ãƒ¼ã§æ‰¿èªã€R ã‚­ãƒ¼ã§å´ä¸‹ã€çŸ¢å°ã‚­ãƒ¼ã§ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
  </div>

  {/* ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆæœ‰åŠ¹æ™‚ã®çŠ¶æ…‹é€šçŸ¥ */}
  <div aria-live="polite" aria-atomic="true" className="sr-only">
    {lastAction && `${lastAction}ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ`}
  </div>
</div>
```

### 2. å›½éš›åŒ–å¯¾å¿œ
```typescript
// i18nå¯¾å¿œã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼
const getShortcutKey = (action: string, locale: string) => {
  const shortcuts = {
    ja: { approve: 'A', reject: 'R', changes: 'C', defer: 'D' },
    en: { approve: 'A', reject: 'R', changes: 'C', defer: 'D' },
    // ä»–ã®è¨€èªã§ã‚‚ãƒ­ãƒ¼ãƒå­—ãƒ™ãƒ¼ã‚¹ã§çµ±ä¸€
  };

  return shortcuts[locale]?.[action] || shortcuts.en[action];
};
```

### 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
```typescript
// ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ã§é€£ç¶šå…¥åŠ›ã‚’é˜²ã
export function useKeyboardShortcuts(config: KeyboardShortcutsConfig) {
  const debouncedConfig = useMemo(
    () => Object.fromEntries(
      Object.entries(config).map(([key, fn]) => [
        key,
        debounce(fn, 150) // 150ms ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹
      ])
    ),
    [config]
  );

  // æ—¢å­˜ã®å®Ÿè£…...
}

// ãƒ¡ãƒ¢åŒ–ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–
const ShortcutHelpPanel = memo(({ visible, onClose }) => {
  // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…
});
```

### 4. ãƒ†ã‚¹ãƒˆæ–¹é‡
```typescript
// __tests__/shortcuts.test.tsx
describe('Keyboard Shortcuts', () => {
  it('should trigger approve action on A key press', () => {
    const mockOnApprove = jest.fn();

    render(<ApprovalReviewPage />);

    fireEvent.keyDown(document, { key: 'a', code: 'KeyA' });

    expect(mockOnApprove).toHaveBeenCalledTimes(1);
  });

  it('should not trigger shortcuts when input is focused', () => {
    const mockOnApprove = jest.fn();

    render(<ApprovalReviewPage />);

    const commentInput = screen.getByRole('textbox');
    commentInput.focus();

    fireEvent.keyDown(document, { key: 'a', code: 'KeyA' });

    expect(mockOnApprove).not.toHaveBeenCalled();
  });

  it('should show help panel on ? key press', () => {
    render(<ApprovalReviewPage />);

    fireEvent.keyDown(document, { key: '?', code: 'Slash', shiftKey: true });

    expect(screen.getByText('ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ')).toBeInTheDocument();
  });
});
```

## ğŸ“Š åŠ¹æœæ¸¬å®šæŒ‡æ¨™

### ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆä½¿ç”¨ç‡
```typescript
// analytics/shortcut-metrics.ts
export class ShortcutMetrics {
  private static metrics = {
    totalActions: 0,
    keyboardActions: 0,
    mouseActions: 0,
    shortcutUsage: {} as Record<string, number>
  };

  static trackShortcutUse(shortcut: string) {
    this.metrics.keyboardActions++;
    this.metrics.totalActions++;
    this.metrics.shortcutUsage[shortcut] = (this.metrics.shortcutUsage[shortcut] || 0) + 1;
  }

  static trackMouseAction() {
    this.metrics.mouseActions++;
    this.metrics.totalActions++;
  }

  static getUsageReport() {
    const keyboardRatio = this.metrics.keyboardActions / this.metrics.totalActions;
    return {
      keyboardRatio: keyboardRatio * 100, // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸
      mostUsedShortcut: Object.entries(this.metrics.shortcutUsage)
        .sort(([,a], [,b]) => b - a)[0],
      totalActions: this.metrics.totalActions
    };
  }
}
```

ã“ã®ä»•æ§˜ã«ã‚ˆã‚Šã€æ‰¿èªè€…ã¯å¹´é–“10,000ä»¶ã®å‡¦ç†ã‚’åŠ¹ç‡çš„ã«è¡Œã†ã“ã¨ãŒã§ãã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã«ã‚ˆã£ã¦åˆ¤å®šé€Ÿåº¦ã®å¤§å¹…ãªå‘ä¸ŠãŒæœŸå¾…ã§ãã¾ã™ã€‚